name: camino

services:
  # postgres DBMS
  postgres:
    image: postgres:16.1
    container_name: camino-pgdb
    restart: always
    #command: -c ssl=on -c ssl_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem -c ssl_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /var/lib/postgresql/16.1/data
    volumes:
      - /var/lib/postgresql/16.1/data:/var/lib/postgresql/16.1/data     # DB files dir
      - ./api/db_dump/:/db_dump                                         # DB initial dump
    ports:
      - '5432:5432'
    networks:
      - camino-net 

  # pgAdmin
  pgadmin4:
    image: elestio/pgadmin:latest
    container_name: camino-pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: user@email.com
      PGADMIN_DEFAULT_PASSWORD: 12345678
      PGADMIN_LISTEN_PORT: 8080
    ports:
      - '8082:8080'
    networks:
      - camino-net  

            
      
  # camino RESTAPI
  camino-restapi:
    image: yiisoftware/yii2-php:8.3-apache
    container_name: camino-restapi  
    restart: unless-stopped
    volumes:
      - ./api/:/app
      - ./projects_data/:/projects_data
    ports:
      - '8000:80'      
    networks:
      - camino-net  

  # camino front site
  camino-front:
    image: yiisoftware/yii2-php:8.3-apache
    container_name: camino-front
    restart: unless-stopped
    volumes:
      - ./front/:/app
    ports:
      - '80:80' 
    networks:
      - camino-net  

  # camino back site
  camino-back:
    image: idockerapi
    container_name: camino-back
    build: ./back/caminoapi
    restart: unless-stopped
    volumes:
     - /home/ubuntu/Documents/back/dockerpipe:/code/api/docker/hostpipe
     - /var/run/docker.sock:/var/run/docker.sock
    ports:
    - "8002:80"
    networks:
     - camino-net  
     
  # camino plugins
  camino-plugins: 
    container_name: camino-plugins
    build:
      context: ./plugins/app
      target: builder    
    restart: unless-stopped
    volumes:
      - ./projects_data/:/projects_data
      - /var/run/docker.sock:/var/run/docker.sock      
    # flask requires SIGINT to stop gracefully
    # (default stop signal from Compose is SIGTERM)
    stop_signal: SIGINT
    ports:
      - '5000:5000'
    networks:
      - camino-net 

networks:
  camino-net:
    name: camino-net
    attachable: true
